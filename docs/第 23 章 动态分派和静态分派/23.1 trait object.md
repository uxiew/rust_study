# 23.1 trait object

ä»€ä¹ˆæ˜¯ trait object å‘¢ï¼ŸæŒ‡å‘ trait çš„æŒ‡é’ˆå°±æ˜¯ trait objectã€‚
å‡å¦‚ `Bird` æ˜¯ä¸€ä¸ª trait çš„åç§°ï¼Œé‚£ä¹ˆ `dyn Bird` å°±æ˜¯ä¸€ä¸ª DST åŠ¨æ€å¤§å°ç±»å‹ã€‚`&dyn Bird`ã€`&mut dyn Bird`ã€`Box<dyn Bird>`ã€`*const dyn Bird`ã€`*mut dyn Bird` ä»¥åŠ `Rc<dyn Bird>` ç­‰ç­‰éƒ½æ˜¯ Trait Objectã€‚

ç¤ºä¾‹ï¼š

```rust
use std::fmt::Debug;

fn dyn_trait(n: u8) -> Box<dyn Debug> {
    if n % 2 == 0 {
        Box::new(n)
    } else {
        Box::new(format!("odd {}", n))
    }
}

fn impl_trait(n: u8) -> impl Debug {
    if n % 2 == 0 {
        n.to_string()
    } else {
        format!("odd {}", n)
    }
}

fn main() {
    let x: Box<dyn Debug> = dyn_trait(4);
    println!("{:?}", x);

    let y = impl_trait(5);
    println!("{:?}", y);
}
```

ç¤ºä¾‹ä»£ç ä¸­ï¼Œ`dyn_trait` å’Œ `impl_trait` æ˜¯ä¸¤ä¸ªå‡½æ•°ï¼Œå®ƒä»¬éƒ½è¿”å›å®ç°äº† Debug trait çš„ç±»å‹ã€‚

`dyn_trait` è¿”å›ä¸€ä¸ª Box æŒ‡é’ˆï¼ŒæŒ‡å‘åŠ¨æ€åˆ†å‘çš„ç±»å‹ï¼Œè€Œ `impl_trait` ç›´æ¥è¿”å›ä¸€ä¸ªå®ç°äº† Debug çš„ç±»å‹ï¼ˆåœ¨è¿™é‡Œæ˜¯ `u8` å’Œå­—ç¬¦ä¸²ç±»å‹ï¼‰ã€‚
è¿™æ„å‘³ç€ `dyn_trait` å¯ä»¥å­˜å‚¨ä¸åŒçš„ç±»å‹ï¼Œå¹¶åœ¨è¿è¡Œæ—¶åŠ¨æ€è°ƒç”¨å…¶ Debug å®ç°ï¼Œè€Œ `impl_trait` åªèƒ½è¿”å›å›ºå®šçš„ç±»å‹ï¼ˆåœ¨è¿™é‡Œæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼‰ã€‚

å½“æŒ‡é’ˆæŒ‡å‘ trait çš„æ—¶å€™ï¼Œè¿™ä¸ªæŒ‡é’ˆå°±ä¸æ˜¯ä¸€ä¸ªæ™®é€šçš„æŒ‡é’ˆäº†ï¼Œå˜æˆä¸€ä¸ªâ€œèƒ–æŒ‡é’ˆâ€ã€‚
è¯·å¤§å®¶å›å¿†ä¸€ä¸‹å‰æ–‡æ‰€è®²è§£çš„ DST ç±»å‹ï¼šæ•°ç»„ç±»å‹`[T]`æ˜¯ä¸€ä¸ª DST ç±»å‹ï¼Œå› ä¸ºå®ƒçš„å¤§å°åœ¨ç¼–è¯‘é˜¶æ®µæ˜¯ä¸ç¡®å®šçš„ï¼Œç›¸å¯¹åº”çš„ï¼Œ`&[T]`ç±»å‹å°±æ˜¯ä¸€ä¸ªâ€œèƒ–æŒ‡é’ˆâ€ï¼Œå®ƒä¸ä»…åŒ…å«äº†æŒ‡é’ˆæŒ‡å‘æ•°ç»„çš„å…¶ä¸­ä¸€ä¸ªå…ƒç´ ï¼ŒåŒæ—¶åŒ…å«ä¸€ä¸ªé•¿åº¦ä¿¡æ¯ã€‚å®ƒçš„å†…éƒ¨è¡¨ç¤ºå®è´¨ä¸Šæ˜¯ Slice ç±»å‹ã€‚

åŒç†ï¼ŒBird åªæ˜¯ä¸€ä¸ª trait çš„åå­—ï¼Œç¬¦åˆè¿™ä¸ª trait çš„å…·ä½“ç±»å‹å¯èƒ½æœ‰å¤šç§ï¼Œè¿™äº›ç±»å‹å¹¶ä¸å…·å¤‡åŒæ ·çš„å¤§å°ï¼Œå› æ­¤ä½¿ç”¨ `dyn Bird` æ¥è¡¨ç¤ºæ»¡è¶³ Bird çº¦æŸçš„ DST ç±»å‹ã€‚æŒ‡å‘ DST çš„æŒ‡é’ˆç†æ‰€å½“ç„¶ä¹Ÿåº”è¯¥æ˜¯ä¸€ä¸ªâ€œèƒ–æŒ‡é’ˆâ€ï¼Œå®ƒçš„åå­—å°±å« trait objectã€‚æ¯”å¦‚`Box<dyn Bird>`ï¼Œå®ƒçš„å†…éƒ¨è¡¨ç¤ºå¯ä»¥ç†è§£æˆä¸‹é¢è¿™æ ·ï¼š

```rust
pub struct TraitObject {
    pub data: *mut (),
    pub vtable: *mut (),
}
```

å®ƒé‡Œé¢åŒ…å«äº†ä¸¤ä¸ªæˆå‘˜ï¼Œéƒ½æ˜¯æŒ‡å‘å•å…ƒç±»å‹çš„è£¸æŒ‡é’ˆã€‚åœ¨è¿™é‡Œå£°æ˜çš„æŒ‡é’ˆæŒ‡å‘çš„ç±»å‹å¹¶ä¸é‡è¦ï¼Œæˆ‘ä»¬åªéœ€çŸ¥é“å®ƒé‡Œé¢åŒ…å«äº†ä¸¤ä¸ªè£¸æŒ‡é’ˆå³å¯ã€‚ç”±ä¸Šå¯è§ï¼Œå’Œ Slice ä¸€æ ·ï¼ŒTrait Object é™¤äº†åŒ…å«ä¸€ä¸ªæŒ‡é’ˆä¹‹å¤–ï¼Œè¿˜å¸¦æœ‰å¦å¤–ä¸€ä¸ªâ€œå…ƒæ•°æ®â€ï¼Œå®ƒå°±æ˜¯æŒ‡å‘â€œè™šå‡½æ•°è¡¨â€çš„æŒ‡é’ˆï¼ˆğŸ””ï¼šè™šå‡½æ•°è¡¨ï¼ˆVirtual Function Tableï¼Œç®€ç§° vtableï¼‰ï¼‰ã€‚è¿™é‡Œç”¨çš„æ˜¯è£¸æŒ‡é’ˆï¼ŒæŒ‡å‘ unit ç±»å‹çš„æŒ‡é’ˆ`*mut()`å®é™…ä¸Šç±»ä¼¼äº C è¯­è¨€ä¸­çš„`void*`ã€‚æˆ‘ä»¬æ¥å°è¯•ä¸€ä¸‹ä½¿ç”¨ unsafe ä»£ç ï¼Œå¦‚æœæŠŠå®ƒé‡Œé¢çš„æ•°å€¼å½“æˆæ•´æ•°æ‹¿å‡ºæ¥ä¼šæ˜¯ä»€ä¹ˆç»“æœï¼š

```rust
use std::mem;

trait Bird {
    fn fly(&self);
}

struct Duck;
struct Swan;

impl Bird for Duck {
    fn fly(&self) { println!("duck duck"); }
}

impl Bird for Swan {
    fn fly(&self) { println!("swan swan");}
}
// å‚æ•°æ˜¯ trait object ç±»å‹ï¼Œp æ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆ
fn print_traitobject(p: &dyn Bird) {

    // ä½¿ç”¨ transmute æ‰§è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ŒæŠŠå˜é‡ p çš„å†…éƒ¨æ•°æ®å–å‡ºæ¥
    let (data, vtable) : (usize, * const usize) = unsafe {mem::transmute(p)};
    println!("TraitObject    [data:{}, vtable:{:p}]", data, vtable);
    unsafe {
        // æ‰“å°å‡ºæŒ‡é’ˆ v æŒ‡å‘çš„å†…å­˜åŒºé—´çš„å€¼
        println!("data in vtable [{}, {}, {}, {}]",
            *vtable, *vtable.offset(1), *vtable.offset(2), *vtable.offset(3));
    }
}

fn main() {
    let duck = Duck;
    let p_duck = &duck;
    let p_bird = p_duck as &dyn Bird;
    println!("Size of p_duck {}, Size of p_bird {}", mem::size_of_val(&p_duck), mem::size_of_val(&p_bird));

    let duck_fly : usize = Duck::fly as usize;
    let swan_fly : usize = Swan::fly as usize;
    println!("Duck::fly {}", duck_fly);
    println!("Swan::fly {}", swan_fly);

    print_traitobject(p_bird);
    let swan = Swan;
    print_traitobject(&swan as &dyn Bird);
}
```

æ‰§è¡Œç»“æœä¸ºï¼š

```
Size of p_duck 8, Size of p_bird 16
Duck::fly 139997348684016
Swan::fly 139997348684320
TraitObject    [data:140733800916056, vtable:139997351089872]
data in vtable [139997348687008, 0, 1, 139997348684016]
TraitObject    [data:140733800915512, vtable:139997351089952]
data in vtable [139997348687008, 0, 1, 139997348684320]
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç›´æ¥é’ˆå¯¹å¯¹è±¡å–æŒ‡é’ˆï¼Œå¾—åˆ°çš„æ˜¯æ™®é€šæŒ‡é’ˆï¼Œå®ƒå æ® 64 bit çš„ç©ºé—´ã€‚
å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªæŒ‡é’ˆä½¿ç”¨ `as` è¿ç®—ç¬¦è½¬æ¢ä¸º trait objectï¼Œå®ƒå°±æˆäº†èƒ–æŒ‡é’ˆï¼Œæºå¸¦äº†é¢å¤–çš„ä¿¡æ¯ã€‚è¿™ä¸ªé¢å¤–ä¿¡æ¯å¾ˆé‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨è¿™ä¸ªæŒ‡é’ˆè°ƒç”¨å‡½æ•°ã€‚å¦‚æœæŒ‡å‘ trait çš„æŒ‡é’ˆåªåŒ…å«äº†å¯¹è±¡çš„åœ°å€ï¼Œé‚£ä¹ˆå®ƒå°±æ²¡åŠæ³•å®ç°é’ˆå¯¹ä¸åŒçš„å…·ä½“ç±»å‹è°ƒç”¨ä¸åŒçš„å‡½æ•°äº†ã€‚
æ‰€ä»¥ï¼Œå®ƒä¸ä»…è¦åŒ…å«ä¸€ä¸ªæŒ‡å‘çœŸå®å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿˜è¦æœ‰ä¸€ä¸ªæŒ‡å‘æ‰€è°“çš„â€œè™šå‡½æ•°è¡¨â€çš„æŒ‡é’ˆã€‚
æˆ‘ä»¬æŠŠè™šå‡½æ•°è¡¨é‡Œé¢çš„å†…å®¹æ‰“å°å‡ºæ¥å¯ä»¥çœ‹åˆ°ï¼Œé‡Œé¢æœ‰æˆ‘ä»¬éœ€è¦è¢«è°ƒç”¨çš„å…·ä½“å‡½æ•°çš„åœ°å€ã€‚

ä»è¿™é‡Œçš„åˆ†æç»“æœå¯ä»¥çœ‹åˆ°ï¼ŒRust çš„åŠ¨æ€åˆ†æ´¾å’Œ C++ çš„åŠ¨æ€åˆ†æ´¾ï¼Œå†…å­˜å¸ƒå±€æœ‰æ‰€ä¸åŒã€‚åœ¨ C++ é‡Œï¼Œå¦‚æœä¸€ä¸ªç±»å‹é‡Œé¢æœ‰è™šå‡½æ•°ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªè¿™ç§ç±»å‹çš„å˜é‡å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è™šå‡½æ•°è¡¨çš„åœ°å€ã€‚
è€Œåœ¨ Rust é‡Œé¢ï¼Œå¯¹è±¡æœ¬èº«ä¸åŒ…å«æŒ‡å‘è™šå‡½æ•°è¡¨çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæ˜¯å­˜åœ¨äº trait object æŒ‡é’ˆé‡Œé¢çš„ã€‚å¦‚æœä¸€ä¸ªç±»å‹å®ç°äº†å¤šä¸ª traitï¼Œé‚£ä¹ˆä¸åŒçš„ trait object æŒ‡å‘çš„è™šå‡½æ•°è¡¨ä¹Ÿä¸ä¸€æ ·ã€‚
